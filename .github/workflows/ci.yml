name: GitHub Security Scan with Azure Upload

on:
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:

    # 1️⃣ Checkout Repo
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2️⃣ Create Timestamp Folder
    - name: Create Report Folder
      run: |
        TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
        REPO_NAME=${{ github.event.repository.name }}
        REPORT_DIR="reports/$REPO_NAME/$TIMESTAMP"
        mkdir -p $REPORT_DIR
        echo "REPORT_DIR=$REPORT_DIR" >> $GITHUB_ENV
        echo "SCAN_TIME=$TIMESTAMP" >> $GITHUB_ENV
        echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV

    # 3️⃣ Install Tools
    - name: Install Semgrep
      run: pip install semgrep

    - name: Install Trivy
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy

    - name: Install Gitleaks
      run: |
        wget https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_8.18.2_linux_x64.tar.gz
        tar -xzf gitleaks_8.18.2_linux_x64.tar.gz
        sudo mv gitleaks /usr/local/bin/

    # 4️⃣ Run Scans
    - name: Run Semgrep
      run: |
        semgrep scan . \
          --config auto \
          --json > $REPORT_DIR/semgrep-report.json || true

    - name: Run Trivy
      run: |
        trivy fs . \
          --format json \
          --output $REPORT_DIR/trivy-report.json || true

    - name: Run Gitleaks
      run: |
        gitleaks detect \
          --source . \
          --report-format json \
          --report-path $REPORT_DIR/gitleaks-report.json || true

    # 5️⃣ Add Metadata
    - name: Add Metadata
      run: |
        echo "Repository: $REPO_NAME" > $REPORT_DIR/scan-info.txt
        echo "Branch: ${{ github.ref_name }}" >> $REPORT_DIR/scan-info.txt
        echo "Commit: ${{ github.sha }}" >> $REPORT_DIR/scan-info.txt
        echo "Scan Date: $SCAN_TIME" >> $REPORT_DIR/scan-info.txt

    # 6️⃣ Azure Login
    - name: Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

    # 7️⃣ Upload to Azure Blob
    - name: Upload Reports to Azure Blob
      run: |
        az storage blob upload-batch \
          --account-name gaigkyc \
          --destination securityscanreports \
          --source $REPORT_DIR \
          --overwrite
